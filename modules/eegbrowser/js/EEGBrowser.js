!function(modules){function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:!1};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.loaded=!0,module.exports}var installedModules={};return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.p="",__webpack_require__(0)}([function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function makeRegions(numRegions){for(var regions=[],rc=function(){return Math.floor(250*Math.random())},i=0;i<numRegions;i+=1){var center=new Array(3).fill(0).map(function(){return 2*Math.random()-1}),color={r:rc(),g:rc(),b:rc()},region=new Region("region"+i,"Region "+i,center,color);regions.push(region)}return regions}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_react=__webpack_require__(15),_react2=_interopRequireDefault(_react),_SignalPlot=__webpack_require__(16),_MRILoader=__webpack_require__(18),_MRILoader2=_interopRequireDefault(_MRILoader),_Panel=__webpack_require__(2),_Panel2=_interopRequireDefault(_Panel),_Filters=__webpack_require__(17),NUM_REGIONS=8,POINTS_PER_REGION=5,SAMPLES_PER_POINT=12e3,Region=function(){function Region(name,label,center){var colorCode=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{r:0,g:0,b:0};_classCallCheck(this,Region),this.name=name,this.label=label,this.colorCode=colorCode,this.channels=[],this.generateChannels(POINTS_PER_REGION,center)}return _createClass(Region,[{key:"generateChannels",value:function(numChannels,center){for(var i=0;i<numChannels;i+=1){var channel=new Array(3).fill(0).map(function(){return(2*Math.random()-1)/NUM_REGIONS});channel[0]+=center[0],channel[1]+=center[1],channel[2]+=center[2],this.channels.push(new _SignalPlot.Channel(this.name+" : channel_"+i,channel,SAMPLES_PER_POINT))}}}]),Region}(),BRAIN_MOCK={type:"inner",label:"Brain",value:[{type:"inner",label:"Left Hemisphere",value:[{type:"leaf",label:"Lobe 1",value:makeRegions(NUM_REGIONS)},{type:"leaf",label:"Lobe 2",value:makeRegions(NUM_REGIONS)},{type:"leaf",label:"Lobe 3",value:makeRegions(NUM_REGIONS)}]},{type:"inner",label:"Right Hemisphere",value:[{type:"leaf",label:"Lobe 4",value:makeRegions(NUM_REGIONS)},{type:"leaf",label:"Lobe 5",value:makeRegions(NUM_REGIONS)},{type:"leaf",label:"Lobe 6",value:makeRegions(NUM_REGIONS)}]}]},getLeafRegions=function getLeafRegions(node){switch(node.type){case"inner":return node.value.map(getLeafRegions).reduce(function(list,next){return list.concat(next)});case"leaf":return node.value}return[]},RegionSelect=function(_Component){function RegionSelect(props){_classCallCheck(this,RegionSelect);var _this=_possibleConstructorReturn(this,(RegionSelect.__proto__||Object.getPrototypeOf(RegionSelect)).call(this,props));return _this.defaultProps={brain:[],selected:[]},_this.state={activePage:props.brain,pageStack:[]},_this}return _inherits(RegionSelect,_Component),_createClass(RegionSelect,[{key:"render",value:function(){var _this2=this,clickPage=function(node){var lastPage=_this2.state.activePage,pageStack=_this2.state.pageStack;pageStack.push(lastPage),_this2.setState({activePage:node,pageStack:pageStack})},back=function(){var activePage=_this2.state.pageStack.pop();_this2.setState({activePage:activePage,pageStack:_this2.state.pageStack})},renderRegionElement=function(region,selected,onclick){var c=region.colorCode;return _react2.default.createElement("li",{key:region.name,className:"region-select-item "+(selected?"selected-region":"unselected-region"),onClick:function(){return onclick(region)},onMouseEnter:function(){_this2.props.hoverRegions([region])},onMouseLeave:_this2.props.onMouseLeave},_react2.default.createElement("div",{className:"region-color-code",style:{backgroundColor:"rgb("+c.r+", "+c.g+", "+c.b+")"}}),region.label)},renderRegionSelector=function(region){return _this2.props.selected.find(function(r){return r===region})?renderRegionElement(region,!0,_this2.props.unselectRegion):renderRegionElement(region,!1,_this2.props.selectRegion)},renderInnerNode=function(node){var regions=getLeafRegions(node);return _react2.default.createElement("li",{key:node.label,className:"region-select-item",onClick:function(){return clickPage(node)},onMouseEnter:function(){_this2.props.hoverRegions(regions)},onMouseLeave:_this2.props.onMouseLeave},node.label)},renderNode=function(node){if(!node)return null;switch(node.type){case"inner":return node.value.map(renderInnerNode);case"leaf":return node.value.map(renderRegionSelector)}return null};return _react2.default.createElement("div",{className:"region-select"},_react2.default.createElement("div",{className:"toolbar"},_react2.default.createElement("div",{className:"toolbar-layer"},_react2.default.createElement("div",{className:"toolbar-buttons"},_react2.default.createElement("div",{className:"round-button"+(0===this.state.pageStack.length?" disabled":""),onClick:back},"Back")))),_react2.default.createElement("ul",{className:"region-select-list"},renderNode(this.state.activePage)))}}]),RegionSelect}(_react.Component),SelectionFilters=function(_Component2){function SelectionFilters(props){_classCallCheck(this,SelectionFilters);var _this3=_possibleConstructorReturn(this,(SelectionFilters.__proto__||Object.getPrototypeOf(SelectionFilters)).call(this,props));return _this3.state={tags:{}},_this3}return _inherits(SelectionFilters,_Component2),_createClass(SelectionFilters,[{key:"render",value:function(){var _this4=this,addTag=function(key,value,label,optionLabel){var tags=_this4.state.tags,newTag={value:value,label:label,optionLabel:optionLabel};tags[key]?tags[key].find(function(tag){return tag.value===value})||tags[key].push(newTag):tags[key]=[newTag],_this4.setState({tags:tags})},setDropdown=function(k,v){_this4.setState(_defineProperty({},k,v))},dropdownProps=function(userInputCallback,props){var onUserInput=function(k,v){return userInputCallback(k,v,props.label,props.options[v])};return Object.assign({onUserInput:onUserInput},props)},removeTag=function(tagKey,tag){var tags=_this4.state.tags;tags[tagKey]&&(tags[tagKey]=tags[tagKey].filter(function(t){return t.value!==tag.value})),_this4.setState({tags:tags})},tagRemover=function(tagKey,tag){return _react2.default.createElement("span",{className:"tag-remove-button",onClick:function(){return removeTag(tagKey,tag)}},"x")},tagElements=[];Object.keys(this.state.tags).forEach(function(key){var tags=_this4.state.tags[key],tagElems=tags.map(function(tag){return _react2.default.createElement("span",{key:tag.optionLabel,className:"selection-filter-tag"},tag.label,": ",tag.optionLabel," ",tagRemover(key,tag))});tagElements.push.apply(tagElements,_toConsumableArray(tagElems))});var regionTagRemover=function(region){return _react2.default.createElement("span",{className:"tag-remove-button",onClick:function(){return _this4.props.onRemoveRegion(region)}},"x")},regionTagElements=this.props.selectedRegions.map(function(region){return _react2.default.createElement("span",{key:region.name,className:"selection-filter-tag"},region.name," ",regionTagRemover(region))}),formElements={center:dropdownProps(addTag,{type:"select",name:"center",label:"Center",options:{M:"MNI",N:"CHUM",G:"CHUGA"}}),electrodeType:dropdownProps(addTag,{type:"select",name:"electrodeType",label:"Electrode Type",options:{D:"Dixi sEEG",M:"Custom-built MNI sEEG",A:" Ad-Tech depth",G:"Ad-Tech subdural grid/strip"}}),notRepeatedContacts:dropdownProps(setDropdown,{type:"select",name:"notRepeatedContacts",value:this.state.notRepeatedContacts,label:"Non-Repeated Contacts",options:{nonrepeated:"Show not repeated contacts"}}),oneContactPerPatientPerRegion:dropdownProps(setDropdown,{type:"select",name:"oneContactPerPatientPerRegion",value:this.state.oneContactPerPatientPerRegion,label:"One Contact Per Patient Per Region",options:{onepppr:"Show one contact per patient per region"}})};return _react2.default.createElement(_Panel2.default,{title:"Channel Selection Filters"},_react2.default.createElement(FormElement,{name:"selectionFilters",columns:2,formElements:formElements}),_react2.default.createElement("div",{className:"selection-filter-tags"},"Filter Tags: ",tagElements),_react2.default.createElement("div",{className:"selection-filter-tags"},"Region Tags: ",regionTagElements))}}]),SelectionFilters}(_react.Component),YELLOW=16737832,GREEN=3450963,BLUE=4359668,MRIView=function(_Component3){function MRIView(){return _classCallCheck(this,MRIView),_possibleConstructorReturn(this,(MRIView.__proto__||Object.getPrototypeOf(MRIView)).apply(this,arguments))}return _inherits(MRIView,_Component3),_createClass(MRIView,[{key:"componentDidMount",value:function(){var _this6=this,width=400,height=350,renderer=new THREE.WebGLRenderer;this.canvas=renderer.domElement,this.canvas.width=width,this.canvas.height=height,this.addCanvas(),renderer.setSize(width,height),this.camera=new THREE.PerspectiveCamera(45,width/height,1,1e5),this.controls=new THREE.OrbitControls(this.camera,this.canvas),this.scene=new THREE.Scene,this.mriLoader=new _MRILoader2.default(this.scene),this.meshes=[],this.mriLoader.initialize().then(function(){function run(){renderer.render(self.scene,self.camera),window.requestAnimationFrame(run.bind(self))}var dimensions=_this6.mriLoader.getShaderManager().getDimensions(),x=dimensions.x,y=dimensions.y,z=dimensions.z,scale=Math.min(x,y,z)/2,diagonal=dimensions.length();_this6.camera.position.z=diagonal,_this6.camera.lookAt(new THREE.Vector3(0,0,0));var material=new THREE.MeshBasicMaterial({color:YELLOW}),geometry=new THREE.SphereBufferGeometry(scale/(10*NUM_REGIONS),8,8);_this6.props.regions.forEach(function(region,i){region.channels.forEach(function(channel){var mesh=new THREE.Mesh(geometry,new THREE.MeshBasicMaterial);mesh.material.copy(material),mesh.position.fromArray(channel.position),mesh.position.multiplyScalar(scale),_this6.scene.add(mesh),_this6.meshes[i]||(_this6.meshes[i]=[]),_this6.meshes[i].push(mesh)})});var self=_this6;run()})}},{key:"componentDidUpdate",value:function(){var _this7=this;this.addCanvas(),this.props.regions.forEach(function(region,i){region.channels.forEach(function(channel){_this7.meshes[i]&&(_this7.meshes[i].forEach(function(m){m.material.color.setHex(YELLOW)}),_this7.props.selected.find(function(r){return r===region})&&_this7.meshes[i].forEach(function(m){m.material.color.setHex(GREEN)}),_this7.props.hoveredRegions.includes(region)&&_this7.meshes[i].forEach(function(m){m.material.color.setHex(BLUE)}))})})}},{key:"addCanvas",value:function(){this.container&&this.lastContainer!==this.container&&(this.container.appendChild(this.canvas),this.lastContainer=this.container)}},{key:"render",value:function(){var _this8=this;return this.props.showMRI?_react2.default.createElement("div",{className:"mri-view-container",ref:function(div){_this8.container=div}}):null}}]),MRIView}(_react.Component),SignalFilterSelect=function(_Component4){function SignalFilterSelect(props){return _classCallCheck(this,SignalFilterSelect),_possibleConstructorReturn(this,(SignalFilterSelect.__proto__||Object.getPrototypeOf(SignalFilterSelect)).call(this,props))}return _inherits(SignalFilterSelect,_Component4),_createClass(SignalFilterSelect,[{key:"render",value:function(){var _this10=this,optionElement=function(option){return _react2.default.createElement("option",{key:option.key,value:option.key},option.label)};return _react2.default.createElement("select",{className:"signal-filter-dropdown",onChange:function(e){_this10.props.onChange(e.target.value)},value:this.props.filter},this.props.filters.map(optionElement))}}]),SignalFilterSelect}(_react.Component),ZOOM_AMOUNT=1,INTERVAL_MOVE_AMOUNT=1,PLOTS_PER_GROUP=7,PLOT_HEIGHT=90,Y_BOUNDS={ymin:-2.1,ymax:2.1},Y_WIDTH=60,countNumChannels=function(regions){return regions.map(function(r){return r.channels.length}).reduce(function(a,b){return a+b},0)},SignalPlots=function(_Component5){function SignalPlots(props){_classCallCheck(this,SignalPlots);var _this11=_possibleConstructorReturn(this,(SignalPlots.__proto__||Object.getPrototypeOf(SignalPlots)).call(this,props));return _this11.lastMouseX=null,_this11.drawn=[],_this11.state={cursorT:null,group:0,tBounds:{tmin:-.1,tmax:20},yBounds:{},filters:{low:"none",hi:"none"}},_this11}return _inherits(SignalPlots,_Component5),_createClass(SignalPlots,[{key:"componentWillReceiveProps",value:function(nextProps){var minPlot=(PLOTS_PER_GROUP-1)*this.state.group,numChannels=countNumChannels(nextProps.selected),newGroup=minPlot>numChannels?Math.floor(numChannels/PLOTS_PER_GROUP):this.state.group;this.setState({group:newGroup})}},{key:"componentDidMount",value:function(){var _this12=this;this.resizeUpdate=function(){_this12.forceUpdate()},window.addEventListener("resize",this.resizeUpdate),window.addEventListener("mouseup",function(){_this12.lastMouseX=null})}},{key:"componentWillUnmount",value:function(){window.removeEveEventListener("resize",this.resizeUpdate)}},{key:"generatePlotElements",value:function(minPlot,maxPlot){var _this13=this,plotElements=[],index=0;return this.props.selected.forEach(function(region){region.channels.forEach(function(channel){var _state$filters=_this13.state.filters,low=_state$filters.low,hi=_state$filters.hi;channel.applyFilter(low,hi);var axisProps={drawXAxis:!1,xAxisLabel:"time (sec)",yAxisLabel:"uV"};if(index===minPlot&&(axisProps.drawXAxis=!0,axisProps.xAxisOrientation="top",axisProps.xAxisLabelPos=null,axisProps.yAxisLabelPos={x:-23,y:10}),index===maxPlot&&(axisProps.drawXAxis=!0,axisProps.xAxisOrientation="bottom",axisProps.xAxisLabelPos={x:5,y:28},axisProps.yAxisLabelPos={x:-23,y:7}),index>=minPlot&&index<=maxPlot){var zoom=function(leftClick,multiplier){if(leftClick){_this13.state.yBounds[channel.name]=_this13.state.yBounds[channel.name]||Y_BOUNDS;var _state$yBounds$channe=_this13.state.yBounds[channel.name],_ymin=_state$yBounds$channe.ymin,_ymax=_state$yBounds$channe.ymax;_ymin*=multiplier,_ymax*=multiplier,_this13.state.yBounds[channel.name]={ymin:_ymin,ymax:_ymax},_this13.setState({yBounds:_this13.state.yBounds})}},_ref=_this13.state.yBounds[channel.name]||Y_BOUNDS,ymin=_ref.ymin,ymax=_ref.ymax;plotElements.push(_react2.default.createElement(_SignalPlot.SignalPlot,{key:index,className:"signal-plot-item",channel:channel,colorCode:region.colorCode,height:PLOT_HEIGHT,yAxisWidth:Y_WIDTH,tBounds:_this13.state.tBounds,yBounds:{ymin:ymin,ymax:ymax},onPlus:function(e){e.stopPropagation(),zoom(0===e.button,.9)},onMinus:function(e){e.stopPropagation(),zoom(0===e.button,1.1)},backgroundColor:index%2===0?"#fff":"#eee",cursorT:_this13.state.cursorT,drawXAxis:axisProps.drawXAxis,xAxisOrientation:axisProps.xAxisOrientation,xAxisLabel:axisProps.xAxisLabel,xAxisLabelPos:axisProps.xAxisLabelPos,yAxisLabel:axisProps.yAxisLabel,yAxisLabelPos:axisProps.yAxisLabelPos}))}index++})}),plotElements}},{key:"render",value:function(){var _this14=this,numChannels=countNumChannels(this.props.selected),minPlot=(PLOTS_PER_GROUP-1)*this.state.group,maxPlot=(PLOTS_PER_GROUP-1)*(this.state.group+1),showNext=maxPlot<numChannels,showPrev=this.state.group>0;minPlot+PLOTS_PER_GROUP>numChannels&&(maxPlot=Math.min(minPlot+PLOTS_PER_GROUP,numChannels)-1);var _onWheel=function(dy){var _state$tBounds=_this14.state.tBounds,tmin=_state$tBounds.tmin,tmax=_state$tBounds.tmax;tmax-tmin<=.5&&dy<0||tmax-tmin>=25&&dy>0||_this14.setState({tBounds:{tmin:tmin-Math.sign(dy)*ZOOM_AMOUNT*(tmax-tmin)/15,tmax:tmax+Math.sign(dy)*ZOOM_AMOUNT*(tmax-tmin)/15}})},_onMouseMove=function(shift,leftClick,x){if(!_this14.lastMouseX)return void(_this14.lastMouseX=x);var _container$getBoundin=_this14.container.getBoundingClientRect(),width=_container$getBoundin.width,left=_container$getBoundin.left,_state$tBounds2=_this14.state.tBounds,tmin=_state$tBounds2.tmin,tmax=_state$tBounds2.tmax,dx=x-_this14.lastMouseX;if(_this14.lastMouseX=x,shift&&leftClick&&_this14.setState({tBounds:{tmin:tmin-dx*INTERVAL_MOVE_AMOUNT*(tmax-tmin)/width,tmax:tmax-dx*INTERVAL_MOVE_AMOUNT*(tmax-tmin)/width}}),!shift&&leftClick){var tInv=d3.scale.linear().domain([Y_WIDTH,width-Y_WIDTH/4]).range([tmin,tmax]);x-left>Y_WIDTH&&_this14.setState({cursorT:tInv(x-left)})}},selectLow=function(value){_this14.setState({filters:{low:value,hi:_this14.state.filters.hi}})},selectHi=function(value){_this14.setState({filters:{low:_this14.state.filters.low,hi:value}})},enabled=function(text,incr){return _react2.default.createElement("div",{className:"round-button",onClick:function(){_this14.setState({group:_this14.state.group+incr})}},text)},disabled=function(text){return _react2.default.createElement("div",{className:"round-button disabled"},text)},showingPlots=_react2.default.createElement("div",{className:"signal-plots-group-number"},"Showing plots: ",minPlot+1," to ",maxPlot+1," out of ",numChannels),plotElements=this.generatePlotElements(minPlot,maxPlot);return _react2.default.createElement("div",{className:"signal-plots-container"},_react2.default.createElement("div",{className:"toolbar"},_react2.default.createElement("div",{className:"toolbar-layer"},_react2.default.createElement("div",{className:"toolbar-buttons"},showPrev?enabled("Previous",-1):disabled("Previous"),showNext?enabled("Next",1):disabled("Next"),numChannels>0?showingPlots:null)),_react2.default.createElement("div",{className:"toolbar-layer"},_react2.default.createElement("div",{className:"round-button",onClick:function(){_this14.setState({yBounds:{}})}},"Reset Y Zoom"),_react2.default.createElement("div",{className:"signal-plots-filters"},_react2.default.createElement(SignalFilterSelect,{filters:_Filters.LOW_PASS_FILTERS,filter:this.state.filters.low,onChange:selectLow}),_react2.default.createElement(SignalFilterSelect,{filters:_Filters.HIGH_PASS_FILTERS,filter:this.state.filters.hi,onChange:selectHi})))),_react2.default.createElement("div",{className:"signal-plots",ref:function(container){_this14.container=container},onWheel:function(e){e.shiftKey&&(e.preventDefault(),_onWheel(e.deltaY))},onMouseMove:function(e){_onMouseMove(e.shiftKey,e.buttons>0&&0===e.button,e.clientX)},onMouseDown:function(e){_onMouseMove(e.shiftKey,e.buttons>0&&0===e.button,e.clientX)}},plotElements))}}]),SignalPlots}(_react.Component),EEGBrowser=function(_Component6){function EEGBrowser(props){_classCallCheck(this,EEGBrowser);var _this15=_possibleConstructorReturn(this,(EEGBrowser.__proto__||Object.getPrototypeOf(EEGBrowser)).call(this,props));return _this15.state={brain:props.brain||BRAIN_MOCK,selected:[BRAIN_MOCK.value[0].value[0].value[0]],hoveredRegions:[],expanded:!1},_this15}return _inherits(EEGBrowser,_Component6),_createClass(EEGBrowser,[{key:"render",value:function(){var _this16=this,unselectRegion=function(region){_this16.setState({selected:_this16.state.selected.filter(function(r){return r!==region})})},selectRegion=function(region){_this16.setState({selected:_this16.state.selected.filter(function(r){return r!==region}).concat([region])})},expandBar=_react2.default.createElement("div",{className:"expand-bar",onClick:function(){return _this16.setState({expanded:!_this16.state.expanded})}},_react2.default.createElement("span",{className:"expand-bar-icon"},this.state.expanded?">":"<")),regionSelect=_react2.default.createElement(RegionSelect,{brain:this.state.brain,selected:this.state.selected,unselectRegion:unselectRegion,selectRegion:selectRegion,hoverRegions:function(regions){_this16.setState({hoveredRegions:regions})},onMouseLeave:function(){_this16.setState({hoveredRegions:[]})}}),l=getLeafRegions(this.state.brain),mriView=_react2.default.createElement(MRIView,{regions:l,selected:this.state.selected,hoveredRegions:this.state.hoveredRegions,showMRI:!this.state.expanded});return _react2.default.createElement("div",{className:"eeg-browser"},_react2.default.createElement("div",{className:"eeg-browser-row"},_react2.default.createElement(SelectionFilters,{selectedRegions:this.state.selected,onRemoveRegion:unselectRegion})),_react2.default.createElement("div",{className:"eeg-browser-row"},this.state.expanded?null:regionSelect,mriView,expandBar,_react2.default.createElement(SignalPlots,{selected:this.state.selected})))}}]),EEGBrowser}(_react.Component);exports.default=EEGBrowser,window.EEGBrowser=_react2.default.createFactory(EEGBrowser)},,function(module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Panel=function(_React$Component){function Panel(props){_classCallCheck(this,Panel);var _this=_possibleConstructorReturn(this,(Panel.__proto__||Object.getPrototypeOf(Panel)).call(this,props));return _this.state={collapsed:_this.props.initCollapsed},_this.panelClass=_this.props.initCollapsed?"panel-collapse collapse":"panel-collapse collapse in",_this.toggleCollapsed=_this.toggleCollapsed.bind(_this),_this}return _inherits(Panel,_React$Component),_createClass(Panel,[{key:"toggleCollapsed",value:function(){this.setState({collapsed:!this.state.collapsed})}},{key:"render",value:function(){var glyphClass=this.state.collapsed?"glyphicon pull-right glyphicon-chevron-down":"glyphicon pull-right glyphicon-chevron-up",panelHeading=this.props.title?React.createElement("div",{className:"panel-heading",onClick:this.toggleCollapsed,"data-toggle":"collapse","data-target":"#"+this.props.id,style:{cursor:"pointer"}},this.props.title,React.createElement("span",{className:glyphClass})):"";return React.createElement("div",{className:"panel panel-primary"},panelHeading,React.createElement("div",{id:this.props.id,className:this.panelClass,role:"tabpanel"},React.createElement("div",{className:"panel-body",style:{height:this.props.height}},this.props.children)))}}]),Panel}(React.Component);Panel.propTypes={id:React.PropTypes.string,height:React.PropTypes.string,title:React.PropTypes.string},Panel.defaultProps={initCollapsed:!1,id:"default-panel",height:"100%"},exports.default=Panel},,,,,,,,,,,,,function(module,exports){module.exports=React},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.SignalPlot=exports.Channel=void 0;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_react=__webpack_require__(15),_react2=_interopRequireDefault(_react),_Filters=__webpack_require__(17),drawSignalLine=(exports.Channel=function(){function Channel(name,position,timeSamples){var _this=this,tmin=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,tmax=arguments.length>4&&void 0!==arguments[4]?arguments[4]:60;_classCallCheck(this,Channel),this.name=name,this.tmin=tmin,this.tmax=tmax,this.domain=new Float32Array(timeSamples).fill(0),this.domain.forEach(function(_,i){var t=i/timeSamples;_this.domain[i]=tmin*(1-t)+tmax*t}),this.originalSignal=new Float32Array(timeSamples).fill(0),this.originalSignal.forEach(function(_,i){_this.originalSignal[i]=2*Math.random()-1}),this.position=position,this.hovered=!1,this.signal=this.originalSignal,this.filters={}}return _createClass(Channel,[{key:"applyFilter",value:function(lowPassFilterName,highPassFilterName){var _this2=this;if(this.filters.low!==lowPassFilterName||this.filters.hi!==highPassFilterName){var diffFilter=new differenceequationsignal1d.DifferenceEquationSignal1D;diffFilter.enableBackwardSecondPass;var doFilterUpdate=function(coefficients,input){return coefficients?(diffFilter.setInput(input),diffFilter.setACoefficients(coefficients.a),diffFilter.setBCoefficients(coefficients.b),diffFilter.run(),void(_this2.signal=diffFilter.getOutput())):void(_this2.signal=input)};doFilterUpdate(_Filters.FILTERS[lowPassFilterName],this.originalSignal),doFilterUpdate(_Filters.FILTERS[highPassFilterName],this.signal)}}}]),Channel}(),function(ctx,tScale,yScale,channel,indexes){var startx=tScale(channel.domain[indexes[0]]),starty=yScale(channel.signal[indexes[0]]);ctx.strokeStyle="#00a1ff",ctx.lineWidth=2,ctx.moveTo(startx,starty),ctx.beginPath(),indexes.forEach(function(i){var _ref=[tScale(channel.domain[i]),yScale(channel.signal[i])],x=_ref[0],y=_ref[1];ctx.lineTo(x,y)}),ctx.stroke()}),drawSecondTicks=function(ctx,height,tScale,tmin,tmax){var ctmin=Math.ceil(tmin),ctmax=Math.ceil(tmax);ctx.strokeStyle="#999",ctx.lineWidth=1;for(var t=ctmin;t<ctmax;t++)ctx.beginPath(),ctx.moveTo(tScale(t),0),ctx.lineTo(tScale(t),height),ctx.stroke()},drawCursorTick=function(g,height,x){return g.append("line").attr({x1:x,y1:0}).attr({x2:x,y2:height}).attr("stroke-width",1).attr("stroke","#900")},drawMidLine=function(g,tScale,yScale,midPoint,tmin,tmax){return g.append("line").attr({x1:tScale(tmin),y1:yScale(midPoint)}).attr({x2:tScale(tmax),y2:yScale(midPoint)}).attr("stroke-width",1).attr("stroke","#555")},drawRegionColorCode=function(g,height,color){return g.append("line").attr({x1:5,y1:0}).attr({x2:5,y2:height}).attr("stroke-width",4).attr("stroke","rgba("+color.r+", "+color.g+", "+color.b+", 1.0)")};exports.SignalPlot=function(_Component){function SignalPlot(props){_classCallCheck(this,SignalPlot);var _this3=_possibleConstructorReturn(this,(SignalPlot.__proto__||Object.getPrototypeOf(SignalPlot)).call(this,props));return _this3.svg=null,_this3}return _inherits(SignalPlot,_Component),_createClass(SignalPlot,[{key:"getDimensions",value:function(){var _props=this.props,width=_props.width,height=_props.height;return width?{width:width,height:height}:{width:this.div.getBoundingClientRect().width-(this.props.yAxisWidth||60),height:height}}},{key:"getD3Scales",value:function(){var _props$tBounds=(this.props.channel,this.props.tBounds),tmin=_props$tBounds.tmin,tmax=_props$tBounds.tmax,_props$yBounds=this.props.yBounds,ymin=_props$yBounds.ymin,ymax=_props$yBounds.ymax,_getDimensions=this.getDimensions(),width=_getDimensions.width,height=_getDimensions.height,t=d3.scale.linear().domain([tmin,tmax]).rangeRound([0,width]),tInv=d3.scale.linear().domain([0,width]).range([tmin,tmax]),y=d3.scale.linear().domain([ymin,ymax]).rangeRound([height,0]),yInv=d3.scale.linear().domain([0,height]).range([ymax,ymin]);return{t:t,y:y,tInv:tInv,yInv:yInv}}},{key:"getD3Axes",value:function(){var _getD3Scales=this.getD3Scales(),t=_getD3Scales.t,y=_getD3Scales.y,yInv=_getD3Scales.yInv,xAxis=d3.svg.axis().scale(t).ticks(10).outerTickSize(0).orient("bottom"),upperYLabelVal=Math.round(10*yInv(.75*this.props.height))/10,lowerYLabelVal=Math.round(10*yInv(.25*this.props.height))/10,yAxis=d3.svg.axis().scale(y).ticks(0).tickValues([lowerYLabelVal,0,upperYLabelVal]).outerTickSize(0).orient("left");return{xAxis:xAxis,yAxis:yAxis}}},{key:"getSignalIndexes",value:function(){var _props2=this.props,channel=_props2.channel,cursorT=_props2.cursorT,_props$tBounds2=this.props.tBounds,tmin=_props$tBounds2.tmin,tmax=_props$tBounds2.tmax,_getD3Scales2=this.getD3Scales(),cursTime=(_getD3Scales2.t,"NA"),cursVal="NA";cursorT&&(cursTime=Math.round(100*cursorT)/100);var ts=channel.domain,indexFilter=function(indexes,t,i){if(t>=tmin&&t<=tmax&&(indexes.push(i),i<ts.length-1&&cursorT>=t&&cursorT<ts[i+1])){var v1=channel.signal[i],v2=channel.signal[i+1],s=(cursorT-ts[i])/(ts[i+1]-ts[i]);cursVal=v1*(1-s)+v2*s,cursVal=Math.round(100*cursVal)/100}return indexes},indexes=ts.reduce(indexFilter,[]);return{indexes:indexes,cursTime:cursTime,cursVal:cursVal}}},{key:"componentDidMount",value:function(){this.renderPlot()}},{key:"componentDidUpdate",value:function(){this.updatePlot()}},{key:"drawYScaleButton",value:function(parent,symbol,x,y){var g=parent.append("g").attr("transform","translate("+x+", "+y+")");return g.attr("class","plot-scale-button").attr("cursor","pointer"),g.append("rect").attr("x",-2).attr("y",-10).attr("width","12px").attr("height","12px").attr("fill","#aaa"),g.append("text").attr("x",4).attr("y",0).attr("font-weight","bold").attr("fill","#000").attr("text-anchor","middle").text(symbol),g}},{
key:"drawXAxes",value:function(svg,parent){var xAx=null,_getD3Scales3=this.getD3Scales(),_getDimensions2=(_getD3Scales3.t,_getD3Scales3.y,this.getDimensions()),height=_getDimensions2.height,_getD3Axes=this.getD3Axes(),xAxis=_getD3Axes.xAxis,_props3=this.props,xAxisLabel=_props3.xAxisLabel,yAxisLabel=_props3.yAxisLabel;if(xAx=parent.append("g").call(xAxis),"top"===this.props.xAxisOrientation&&xAx.attr("transform","translate(0, 0)"),"bottom"===this.props.xAxisOrientation&&(xAx.attr("transform","translate(0, "+height+")"),svg.attr("height",height+50).style("height",height+50+"px")),xAxisLabel&&this.props.xAxisLabelPos){var _props$xAxisLabelPos=this.props.xAxisLabelPos,x=_props$xAxisLabelPos.x,_y=_props$xAxisLabelPos.y;xAx.append("text").attr("x",x).attr("y",_y).text(xAxisLabel)}if(yAxisLabel&&this.props.yAxisLabelPos){var _props$yAxisLabelPos=this.props.yAxisLabelPos,_x3=_props$yAxisLabelPos.x,_y2=_props$yAxisLabelPos.y;xAx.append("text").attr("x",_x3).attr("y",_y2).text(yAxisLabel)}return xAx}},{key:"updatePlot",value:function(){var _this4=this,channel=this.props.channel,_getD3Scales4=this.getD3Scales(),t=_getD3Scales4.t,y=_getD3Scales4.y,_getD3Axes2=this.getD3Axes(),yAxis=(_getD3Axes2.xAxis,_getD3Axes2.yAxis),_props$tBounds3=this.props.tBounds,tmin=_props$tBounds3.tmin,tmax=_props$tBounds3.tmax,_props$yBounds2=this.props.yBounds,ymin=_props$yBounds2.ymin,ymax=_props$yBounds2.ymax,_getDimensions3=this.getDimensions(),width=_getDimensions3.width,height=_getDimensions3.height,_plot=this.plot,div=_plot.div,svg=_plot.svg,g=_plot.g,_getSignalIndexes=this.getSignalIndexes(),indexes=_getSignalIndexes.indexes,cursTime=_getSignalIndexes.cursTime,cursVal=_getSignalIndexes.cursVal;if(this.plot.channelName.text(channel.name+" | "+this.props.xAxisLabel+": "+cursTime+" | value ("+this.props.yAxisLabel+"): "+cursVal),this.plot.cursorTick&&(this.plot.cursorTick.remove(),this.plot.cursorTick=null),this.props.cursorT){var cursorX=t(this.props.cursorT);cursorX>0&&(this.plot.cursorTick=drawCursorTick(g,height,cursorX))}this.plot.xAx&&(this.plot.xAx.remove(),this.plot.xAx=null),div.style("height",height+"px"),svg.attr("height",height).style("min-height",height+"px"),this.props.drawXAxis&&(this.plot.xAx=this.drawXAxes(svg,g)),this.plot.yAx.call(yAxis),this.plot.regionColorCode.remove(),this.plot.regionColorCode=drawRegionColorCode(svg,height,this.props.colorCode);var _plot$canvas$node$get=this.plot.canvas.node().getBoundingClientRect(),_width=_plot$canvas$node$get.width,_height=_plot$canvas$node$get.height;this.plot.canvas.attr("width",_width).attr("height",_height),this.plot.ctx.clearRect(0,0,width,height),this.props.backgroundColor&&(this.plot.ctx.fillStyle=this.props.backgroundColor,this.plot.ctx.fillRect(0,0,width,height)),drawSignalLine(this.plot.ctx,t,y,channel,indexes),drawSecondTicks(this.plot.ctx,height,t,tmin,tmax),this.plot.midLine.remove(),this.plot.midLine=drawMidLine(g,t,y,(ymax+ymin)/2,tmin,tmax),this.plot.btnPlus&&(this.plot.btnPlus.remove(),this.plot.btnPlus=null),this.plot.btnMinus&&(this.plot.btnMinus.remove(),this.plot.btnMinus=null),this.props.onPlus&&(this.plot.btnPlus=this.drawYScaleButton(g,"+",width-25,20),this.plot.btnPlus.on("mousedown",function(){return _this4.props.onPlus(d3.event)})),this.props.onMinus&&(this.plot.btnMinus=this.drawYScaleButton(g,"-",width-25,height-10),this.plot.btnMinus.on("mousedown",function(){return _this4.props.onMinus(d3.event)}))}},{key:"renderPlot",value:function(){var _this5=this,_props4=this.props,channel=_props4.channel,yAxisWidth=_props4.yAxisWidth,_props$tBounds4=this.props.tBounds,tmin=_props$tBounds4.tmin,tmax=_props$tBounds4.tmax,_props$yBounds3=this.props.yBounds,ymin=_props$yBounds3.ymin,ymax=_props$yBounds3.ymax,_getD3Scales5=this.getD3Scales(),t=_getD3Scales5.t,y=_getD3Scales5.y,_getD3Axes3=this.getD3Axes(),yAxis=(_getD3Axes3.xAxis,_getD3Axes3.yAxis),_getDimensions4=this.getDimensions(),width=_getDimensions4.width,height=_getDimensions4.height,div=d3.select(this.div).style("height",height+"px").style("width","100%"),svg=d3.select(this.svg).attr("height",height).style("min-height",height+"px").style("position","relative").style("top",-height+"px"),g=svg.append("g").attr("transform","translate("+(yAxisWidth||60)+", 0)").attr("width","100%"),canvas=d3.select(this.canvas).attr("x",yAxisWidth||60).attr("y",0).attr("width",width).attr("height",height).style("position","relative").style("left",(yAxisWidth||60)+"px").style("display","flex").style("width","100%").style("height",height+"px").style("margin-right","0"),ctx=canvas.node().getContext("2d");this.props.backgroundColor&&(ctx.fillStyle=this.props.backgroundColor,ctx.fillRect(0,0,width,height));var yAx=g.append("g").call(yAxis),regionColorCode=drawRegionColorCode(svg,height,this.props.colorCode),channelName=g.append("text").attr("x",5).attr("y",height-6).attr("font-size",13),_getSignalIndexes2=this.getSignalIndexes(),indexes=_getSignalIndexes2.indexes,cursTime=_getSignalIndexes2.cursTime,cursVal=_getSignalIndexes2.cursVal;channelName.text(channel.name+" | "+this.props.xAxisLabel+": "+cursTime+" | value ("+this.props.yAxisLabel+"): "+cursVal),drawSignalLine(ctx,t,y,channel,indexes),drawSecondTicks(ctx,height,t,tmin,tmax);var midLine=drawMidLine(g,t,y,(ymax+ymin)/2,tmin,tmax),cursorTick=null;this.props.cursorT&&(cursorTick=drawCursorTick(g,height,t(this.props.cursorT)));var xAx=null;svg.attr("height",height).style("min-height",height+"px"),this.props.drawXAxis&&(xAx=this.drawXAxes(svg,g));var btnPlus=void 0;this.props.onPlus&&(btnPlus=this.drawYScaleButton(g,"+",width-25,20),btnPlus.on("mousedown",function(){return _this5.props.onPlus(d3.event)}));var btnMinus=void 0;this.props.onMinus&&(btnMinus=this.drawYScaleButton(g,"-",width-25,height-10),btnMinus.on("mousedown",function(){return _this5.props.onMinus(d3.event)})),this.plot={div:div,svg:svg,g:g,xAx:xAx,yAx:yAx,height:height,regionColorCode:regionColorCode,channel:channel,channelName:channelName,canvas:canvas,ctx:ctx,cursorTick:cursorTick,midLine:midLine,btnPlus:btnPlus,btnMinus:btnMinus}}},{key:"render",value:function(){var _this6=this;return _react2.default.createElement("div",{ref:function(div){_this6.div=div}},_react2.default.createElement("canvas",{ref:function(canvas){_this6.canvas=canvas}}),_react2.default.createElement("svg",{className:"signal-plot-item",ref:function(svg){_this6.svg=svg}}))}}]),SignalPlot}(_react.Component)},function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.LOW_PASS_FILTERS=[{key:"none",label:"No Low Pass Filter"},{key:"lopass15",label:"Low Pass 15Hz"},{key:"lopass20",label:"Low Pass 20Hz"},{key:"lopass30",label:"Low Pass 30Hz"},{key:"lopass40",label:"Low Pass 40Hz"}],exports.HIGH_PASS_FILTERS=[{key:"none",label:"No High Pass Filter"},{key:"hipass0_5",label:"High Pass 0.5Hz"},{key:"hipass1",label:"High Pass 1Hz"},{key:"hipass5",label:"High Pass 5Hz"},{key:"hipass10",label:"High Pass 10Hz"}],exports.FILTERS={lopass15:{b:[.080716994603448,.072647596309189,.080716994603448],a:[1,-1.27986023820987,.527812029663189]},lopass20:{b:[.113997925584386,.149768961515167,.113997925584386],a:[1,-1.036801335341888,.43695012041825]},lopass30:{b:[.192813914343002,.325725940431161,.192813914343002],a:[1,-.570379950222695,.323884080078956]},lopass40:{b:[.281307434361307,.517866041871659,.281307434361307],a:[1,-.135289362582513,.279792792112445]},hipass0_5:{b:[.937293010134975,-1.874580964130496,.937293010134975],a:[1,-1.985579602684723,.985739491853153]},hipass1:{b:[.930549324176904,-1.861078566912498,.930549324176904],a:[1,-1.971047525054235,.971682555986628]},hipass5:{b:[.877493430773021,-1.754511635757187,.877493430773021],a:[1,-1.851210698908115,.866238657864428]},hipass10:{b:[.81345216101175,-1.625120853023986,.81345216101175],a:[1,-1.694160769645868,.750559011393507]}}},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_ShaderManager=__webpack_require__(19),_ShaderManager2=_interopRequireDefault(_ShaderManager),_MRIOverlay=__webpack_require__(21),_MRIOverlay2=_interopRequireDefault(_MRIOverlay),MODEL_URL="/eegbrowser/static/model_t1w.nii.gz",LABEL_URL="/eegbrowser/static/labels.nii.gz",MRILoader=function(){function MRILoader(scene){_classCallCheck(this,MRILoader),this.scene=scene,this.shaderManager=new _ShaderManager2.default,this.colorMapper=new pixpipe.Colormap,this.colorMapper.setStyle("jet"),this.colorMapper.buildLut(300)}return _createClass(MRILoader,[{key:"initialize",value:function(){var _this=this,promise=this.loadFromURL(MODEL_URL).then(function(){return _this.loadFromURL(LABEL_URL)}).then(function(){var colorMap=_this.colorMapper.createHorizontalLutImage(!1).getData();console.log(colorMap);var texture=new THREE.DataTexture(new Uint8Array(colorMap),colorMap.length/3,1,THREE.RGBFormat);texture.needsUpdate=!0,_this.shaderManager.setArrayUniform("colorMap",1,texture),_this.shaderManager.setArrayUniform("enableColorMap",1,1),_this.createMRIPlanes()});return promise}},{key:"getShaderManager",value:function(){return this.shaderManager}},{key:"loadFromURL",value:function(url){var url2buf=new pixpipe.UrlToArrayBufferReader;url2buf.addInput(url),url2buf.update();var self=this;return new Promise(function(resolve){url2buf.on("ready",function(){var buffer=this.getOutput(),genericDecoder=new pixpipe.Image3DGenericDecoderAlt;if(genericDecoder.addInput(buffer),genericDecoder.update(),!genericDecoder.getNumberOfOutputs())return void console.warn("No output from generic decoder.");var mniVolume=genericDecoder.getOutput();return mniVolume?(self.shaderManager.addOverlay(new _MRIOverlay2.default(url,mniVolume)),void resolve(self.shaderManager)):void console.warn("Non-existant output for genericDecoder.")})})}},{key:"createMRIPlanes",value:function(){var system=new THREE.Object3D,plane=new THREE.Mesh;this.shaderManager.shadePlane(plane),system.add(plane),plane=new THREE.Mesh,plane.rotation.y=Math.PI/2,this.shaderManager.shadePlane(plane),system.add(plane),plane=new THREE.Mesh,this.shaderManager.shadePlane(plane),plane.rotation.x=Math.PI/2,system.add(plane),this.scene.add(system)}}]),MRILoader}();exports.default=MRILoader},function(module,exports,__webpack_require__){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_Shaders=__webpack_require__(20),compareVecs=function(comp){return function(a1,a2){if(a1.length!==a2.length)throw new Error(a1+" and "+a2+" are not equal length");var out=[];return a1.forEach(function(_,i){out[i]=comp(a1[i],a2[i])}),out}},ZERO_VEC_ARRAY=[0,0,0],DEFAULT_SHADER="\n  void main() {\n    discard;\n  }\n",ShaderManager=function(){function ShaderManager(){_classCallCheck(this,ShaderManager),this.material=new THREE.ShaderMaterial({fragmentShader:DEFAULT_SHADER}),this.onResetCallbacks=[],this.box=new THREE.Box3,this.overlayMRIBuffers=[],this.uniforms={trilinearInterpol:{type:"b",value:!1},contrastTexture:{type:"t",value:null},enableConstrast:{type:"b",value:!1},brightness:{type:"f",value:-1},worldMin:{type:"3fv",value:ZERO_VEC_ARRAY},worldMax:{type:"3fv",value:ZERO_VEC_ARRAY},w2v:{type:"Matrix4fv",value:[]},swapMat:{type:"Matrix3fv",value:[]},stride:{type:"3fv",value:[]},dimensions:{type:"3fv",value:[]},weight:{type:"1fv",value:[]},timeIndex:{type:"1fv",value:[]},timeStride:{type:"1fv",value:[]},nbTexturesUsed:{type:"1iv",value:[]},textureSize:{type:"2fv",value:[]},textures:{type:"tv",value:[]},colorMap:{type:"tv",value:[]},enableColorMap:{type:"1iv",value:[]},textureOffsets:{type:"1iv",value:[]}}}return _createClass(ShaderManager,[{key:"getMRIs",value:function(){return this.overlayMRIBuffers}},{key:"getDimensions",value:function(){return this.dimensions||new THREE.Vector3}},{key:"getBoundingBox",value:function(){return this.box}},{key:"addOverlay",value:function(mriOverlay){this.overlayMRIBuffers.push(mriOverlay),this.resetShader()}},{key:"removeOverlay",value:function(index){this.overlayMRIBuffers.splice(index,1),this.resetShader()}},{key:"resetShader",value:function(){var bs=this.overlayMRIBuffers.map(function(b){return b.getUniforms()});this.uniforms.worldMin.value=bs.map(R.prop("worldMin")).reduce(compareVecs(function(x1,x2){return x1<x2?x1:x2}),ZERO_VEC_ARRAY),this.uniforms.worldMax.value=bs.map(R.prop("worldMax")).reduce(compareVecs(function(x1,x2){return x1>x2?x1:x2}),ZERO_VEC_ARRAY);var v1=(new THREE.Vector3).fromArray(this.uniforms.worldMin.value),v2=(new THREE.Vector3).fromArray(this.uniforms.worldMax.value);if(this.dimensions=(new THREE.Vector3).subVectors(v2,v1),this.box.copy(new THREE.Box3(v1,v2)),0===bs.length)return this.material.fragmentShader=DEFAULT_SHADER,this.material.needsUpdate=!0,void this.onResetCallbacks.forEach(function(f){f()});this.uniforms.w2v.value=R.flatten(bs.map(R.prop("w2v"))),this.uniforms.swapMat.value=R.flatten(bs.map(R.prop("swapMat"))),this.uniforms.stride.value=R.flatten(bs.map(R.prop("stride"))),this.uniforms.dimensions.value=R.flatten(bs.map(R.prop("dimensions"))),this.uniforms.weight.value=bs.map(R.prop("weight")),this.uniforms.timeIndex.value=bs.map(R.prop("timeIndex")),this.uniforms.timeStride.value=bs.map(R.prop("timeStride")),this.uniforms.nbTexturesUsed.value=bs.map(R.prop("nbTexturesUsed")),this.uniforms.textureSize.value=R.flatten(bs.map(R.prop("textureSize"))),this.uniforms.textures.value=R.unnest(bs.map(R.prop("textures"))),this.uniforms.colorMap.value=bs.map(R.prop("colorMap")),this.uniforms.enableColorMap.value=bs.map(R.prop("enableColorMap")),this.uniforms.textureOffsets.value=[];for(var offset=0,i=0;i<this.uniforms.nbTexturesUsed.value.length;i+=1)this.uniforms.textureOffsets.value[i]=offset,offset+=this.uniforms.nbTexturesUsed.value[i];this.material.copy(new THREE.ShaderMaterial({side:THREE.DoubleSide,transparent:!0,uniforms:this.uniforms,vertexShader:_Shaders.VERTEX,fragmentShader:(0,_Shaders.FRAGMENT)(this.uniforms.textures.value.length,this.uniforms.textureOffsets.value.length)})),this.material.needsUpdate=!0,this.onResetCallbacks.forEach(function(f){f()})}},{key:"onReset",value:function(callback){callback instanceof Function&&this.onResetCallbacks.push(callback)}},{key:"shadePlane",value:function(plane){if(this.material){var planeSize=2*this.getDimensions().length();plane.material=this.material,plane.geometry=new THREE.PlaneGeometry(planeSize,planeSize),plane.needsUpdate=!0}}},{key:"setUniform",value:function(key,value){var matUniform=R.path(["uniforms",key],this.material);matUniform&&(matUniform.value=value),this.uniforms[key]?this.uniforms[key].value=value:this.uniforms[key]={value:value}}},{key:"setArrayUniform",value:function(key,index,value){var matUniform=R.path(["uniforms",key],this.material);matUniform&&matUniform.value instanceof Array&&(matUniform.value[index]=value),this.uniforms[key]&&this.uniforms[key].value instanceof Array&&(this.uniforms[key].value=R.adjust(R.always(value),index,this.uniforms[key].value),this.overlayMRIBuffers[index]&&(this.overlayMRIBuffers[index].getUniforms()[key]=value))}},{key:"getMaterial",value:function(){return this.material}}]),ShaderManager}();exports.default=ShaderManager},function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.VERTEX="\n  precision highp float;\n\n  varying vec4 worldCoord;\n\n  void main( void )\n  {\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    gl_Position = projectionMatrix * mvPosition;\n    worldCoord = modelMatrix * vec4( position, 1.0 );\n  }\n",exports.FRAGMENT=function(nbTextures,numMRIs){return"\n  precision highp float;\n\n\n  // Use trinlinear interpolation\n  uniform bool trilinearInterpolation;\n\n  // texture that represent the curve data to look up\n  uniform sampler2D contrastTexture;\n\n  // enable contrast curve\n  uniform bool enableConstrast;\n\n  // brightness factor of the voxels\n  uniform float brightness;\n\n  // voxel -> world and world -> voxel transforms\n  uniform vec3 worldMin;\n  uniform vec3 worldMax;\n  uniform mat4 w2v["+numMRIs+"];\n  uniform mat3 swapMat["+numMRIs+"];\n  uniform vec3 stride["+numMRIs+"];\n  uniform vec3 dimensions["+numMRIs+"];\n\n  // sampling weights\n  uniform float weight["+numMRIs+"];\n\n  // Time index and stride for fMRI\n  uniform float timeIndex["+numMRIs+"];\n  uniform float timeStride["+numMRIs+"];\n\n  // number of textures used, and texture array offset of the volumes\n  uniform int nbTexturesUsed["+numMRIs+"];\n  uniform int textureOffsets["+numMRIs+"];\n\n  // buffer sizes and textures array containing all the volumetric data.\n  uniform vec2 textureSize["+nbTextures+"];\n  uniform sampler2D textures["+nbTextures+"];\n\n  // color map textures\n  uniform sampler2D colorMap["+numMRIs+"];\n\n  // enable color maps\n  uniform int enableColorMap["+numMRIs+"];\n\n  // interpolated fragment values\n  varying vec4 worldCoord;\n\n  bool outOfBounds(vec3 pos, vec3 minCoord, vec3 maxCoord)\n  {\n    return (\n      (pos.x <= minCoord.x) || (pos.x >= maxCoord.x) ||\n      (pos.y <= minCoord.y) || (pos.y >= maxCoord.y) ||\n      (pos.z <= minCoord.z) || (pos.z >= maxCoord.z)\n    );\n  }\n\n  float getIntensityWorldNearest(\n    vec3 voxelPos,\n    vec3 dimensions,\n    vec3 stride,\n    float timeIndex,\n    float timeStride,\n    int textureOffset,\n    int nbTexturesUsed\n  )\n  {\n\n    float skipped = 0.0;\n    for (int i = 0; i < "+nbTextures+"; i++)\n    {\n      if (i >= textureOffset && i < textureOffset + nbTexturesUsed)\n      {\n        float bufferSize = floor(textureSize[i].x * textureSize[i].y);\n        if (outOfBounds(voxelPos, vec3(0.0, 0.0, 0.0), dimensions))\n        {\n          skipped += bufferSize;\n          continue;\n        }\n        float offset = floor(dot(voxelPos, stride));\n        offset += timeIndex * timeStride;\n        offset -= skipped;\n        vec2 tex;\n        tex.x = mod(offset, textureSize[i].x) + 0.5;\n        tex.y = floor(offset / textureSize[i].x) + 0.5;\n        tex = tex / textureSize[i];\n        vec4 color = texture2D(textures[i], tex);\n        return color.r;\n      }\n    }\n    return -1.0;\n  }\n  const float EPSILON = 0.06;\n  // return the color corresponding to the given shifted world cooridinates\n  // using a neirest neighbors approx (no interpolation)\n  void getIntensityWorld(inout vec4 colors["+numMRIs+"], vec4 worldCoord)\n  {\n    float maxIntensity = -1.0;\n    for (int i = 0; i < "+numMRIs+"; i++)\n    {\n      vec3 voxelPos = swapMat[i] * (w2v[i] * worldCoord).xzy;\n      voxelPos = floor(voxelPos);\n      float intensity = getIntensityWorldNearest(\n        voxelPos,\n        dimensions[i],\n        stride[i],\n        timeIndex[i],\n        timeStride[i],\n        textureOffsets[i],\n        nbTexturesUsed[i]\n      );\n      if (intensity > maxIntensity) {\n        maxIntensity = intensity;\n      }\n      if (enableConstrast)\n      {\n        intensity = texture2D(contrastTexture, vec2(intensity, 0.5)).r;\n      }\n      if (enableColorMap[i] == 1 && intensity >= EPSILON)\n      {\n        colors[i].rgb = texture2D(colorMap[i], vec2(intensity, 0.5)).rgb;\n        colors[i].a = 1.0;\n      } else {\n        colors[i] = vec4(intensity, intensity, intensity, 1.0);\n      }\n      if (brightness >= 0.0)\n      {\n        colors[i].rgb = clamp(colors[i].rgb * brightness, 0.0, 1.0);\n      }\n      colors[i] *= weight[i];\n    }\n    if (maxIntensity < 0.0) {\n      discard;\n    }\n  }\n\n  void main( void )\n  {\n    if (outOfBounds(worldCoord.xzy, worldMin, worldMax))\n    {\n      discard;\n      return;\n    }\n\n    // interpolation or not\n    vec4 colors["+numMRIs+"];\n    getIntensityWorld(colors, worldCoord);\n\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    for (int i = 0; i < "+numMRIs+"; i++)\n    {\n      gl_FragColor += colors[i];\n    }\n    gl_FragColor  = clamp(gl_FragColor, 0.0, 1.0);\n  }\n"}},function(module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function makeGLTextureViews(data){for(var gl=document.createElement("canvas").getContext("experimental-webgl"),maxTexSize=gl.getParameter(gl.MAX_TEXTURE_SIZE),maxVoxels=maxTexSize*maxTexSize,nbTexturesUsed=Math.ceil(data.length/maxVoxels),textureSize=new Array(nbTexturesUsed),textures=new Array(nbTexturesUsed),i=0;i<nbTexturesUsed;i+=1){textureSize[i]=[maxTexSize,maxTexSize],i>=nbTexturesUsed-1&&(textureSize[i][1]=Math.ceil(data.length/maxTexSize),textureSize[i][1]<=1?textureSize[i][0]=Math.ceil(data.length%maxTexSize):textureSize[i][0]=maxTexSize);for(var texdata=new Uint8Array(textureSize[i][0]*textureSize[i][1]).fill(0),j=0;j<texdata.length;j+=1)texdata[j]=data[i*maxVoxels+j];textures[i]=new THREE.DataTexture(texdata,textureSize[i][0],textureSize[i][1],THREE.LuminanceFormat),textures[i].needsUpdate=!0}return{textures:textures,textureSize:textureSize,nbTexturesUsed:nbTexturesUsed}}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),MRIOverlay=function(){function MRIOverlay(name,image3d){_classCallCheck(this,MRIOverlay),this.name=name,this.image3d=image3d,this.colorMapName=null,this.weight=1,this.timeIndex=0;var timeDim=image3d.getMetadata("dimensions").find(function(d){return"t"===d.nameWorldSpace});this.maxTimeIndex=timeDim?timeDim.length-1:0;var _makeGLTextureViews=makeGLTextureViews(image3d.getDataUint8()),textures=_makeGLTextureViews.textures,textureSize=_makeGLTextureViews.textureSize,nbTexturesUsed=_makeGLTextureViews.nbTexturesUsed,_image3d$getTransfoBo=image3d.getTransfoBox("v2w"),min=_image3d$getTransfoBo.min,max=_image3d$getTransfoBo.max;this.uniforms={worldMin:[min.x,min.y,min.z],worldMax:[max.x,max.y,max.z],w2v:image3d.getMetadata("transformations").w2v,swapMat:image3d.getVoxelCoordinatesSwapMatrix(!0),stride:image3d.getMetadata("dimensions").map(R.prop("stride")).slice(0,3).reverse(),dimensions:image3d.getMetadata("dimensions").map(R.prop("length")).slice(0,3).reverse(),weight:this.weight,timeIndex:this.timeIndex,timeStride:timeDim?timeDim.stride:0,nbTexturesUsed:nbTexturesUsed,textureSize:textureSize,textures:textures,colorMap:null,enableColorMap:0}}return _createClass(MRIOverlay,[{key:"getColormapName",value:function(){return this.colorMapName}},{key:"setColormapName",value:function(name){this.colorMapName=name}},{key:"getWeight",value:function(){return this.weight}},{key:"setWeight",value:function(weight){this.weight=weight}},{key:"getTimeIndex",value:function(){return this.timeIndex}},{key:"setTimeIndex",value:function(timeIndex){this.timeIndex=timeIndex}},{key:"getMaxTime",value:function(){return this.maxTimeIndex}},{key:"getName",value:function(){return this.name}},{key:"getImage3D",value:function(){return this.image3d}},{key:"getUniforms",value:function(){return this.uniforms}}]),MRIOverlay}();exports.default=MRIOverlay}]);
//# sourceMappingURL=EEGBrowser.js.map